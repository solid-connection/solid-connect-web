name: API ë³€ê²½ì‚¬í•­ ë¦¬ë·°

on:
  pull_request:
    paths:
      - 'bruno/**'

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬

      - name: Node ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install

      - name: ë¹Œë“œ
        run: npm run build

      - name: ì´ì „ ë²„ì „ OpenAPI ìƒì„±
        run: |
          # main ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒí•˜ì—¬ ì´ì „ ë²„ì „ ìƒì„±
          git checkout origin/${{ github.base_ref }} -- bruno/ || true
          node dist/cli/index.js generate -i ./bruno -o ./openapi-old.json

      - name: í˜„ì¬ PRì˜ Brunoë¡œ ë³µì›
        run: |
          git checkout ${{ github.head_ref }} -- bruno/ || true
          git checkout HEAD -- bruno/

      - name: í˜„ì¬ ë²„ì „ OpenAPI ìƒì„± ë° ë³€ê²½ì‚¬í•­ ê°ì§€
        run: |
          node dist/cli/index.js generate \
            -i ./bruno \
            -o ./openapi-new.json \
            --title "ìš°ë¦¬íŒ€ API" \
            --version "1.0.0"

          # ë³€ê²½ì‚¬í•­ ê°ì§€
          if [ -f openapi-old.json ]; then
            cp openapi-old.json openapi-new.json.old
            node dist/cli/index.js generate \
              -i ./bruno \
              -o ./openapi-new.json \
              --diff \
              --changelog ./CHANGELOG.md \
              --changelog-format markdown
          fi

      - name: Breaking Changes í™•ì¸
        id: breaking
        run: |
          if [ -f CHANGELOG.md ]; then
            if grep -q "âš ï¸ Breaking Changes" CHANGELOG.md || grep -q "Breaking Changes" CHANGELOG.md; then
              echo "has_breaking=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ Breaking changes ë°œê²¬!"
            else
              echo "has_breaking=false" >> $GITHUB_OUTPUT
              echo "âœ… Breaking changes ì—†ìŒ"
            fi
          else
            echo "has_breaking=false" >> $GITHUB_OUTPUT
          fi

      - name: Bruno íŒŒì¼ ë³€ê²½ì‚¬í•­ í™•ì¸
        id: bruno_changes
        run: |
          # ë³€ê²½ëœ .bru íŒŒì¼ ëª©ë¡
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.bru$' || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changed_files=" >> $GITHUB_OUTPUT
          fi

      - name: PRì— ë³€ê²½ì‚¬í•­ ì½”ë©˜íŠ¸
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            let comment = '## ğŸ”„ API ë³€ê²½ì‚¬í•­\n\n';

            // Breaking changes ê²½ê³ 
            const hasBreaking = '${{ steps.breaking.outputs.has_breaking }}' === 'true';
            if (hasBreaking) {
              comment += '### âš ï¸ **Breaking Changes ë°œê²¬!**\n\n';
              comment += '> ê¸°ì¡´ ì½”ë“œë¥¼ ê¹¨ëœ¨ë¦´ ìˆ˜ ìˆëŠ” ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. í”„ë¡ íŠ¸ì—”ë“œ íŒ€ê³¼ ìƒì˜ í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.\n\n';
            }

            // ë³€ê²½ëœ Bruno íŒŒì¼ ëª©ë¡
            const changedFiles = `${{ steps.bruno_changes.outputs.changed_files }}`;
            if (changedFiles) {
              comment += '### ğŸ“ ë³€ê²½ëœ Bruno íŒŒì¼\n\n';
              comment += '```\n' + changedFiles + '\n```\n\n';
            }

            // Changelog ë‚´ìš©
            if (fs.existsSync('CHANGELOG.md')) {
              const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
              comment += '### ğŸ“Š ìƒì„¸ ë³€ê²½ì‚¬í•­\n\n';
              comment += changelog;
            } else {
              comment += '### âœ¨ ìƒˆë¡œìš´ APIê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
              comment += 'ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ë ¤ë©´ Bruno íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.\n';
            }

            // API ë¬¸ì„œ ë§í¬ (ë°°í¬ í›„)
            comment += '\n---\n\n';
            comment += '### ğŸ”— ìœ ìš©í•œ ë§í¬\n\n';
            comment += '- ğŸ“– [API ëª…ì„¸ì„œ ë³´ê¸°](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/api-viewer.html)\n';
            comment += '- ğŸ”„ [ë³€ê²½ì‚¬í•­ ì‹œê°í™”](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/changelog.html)\n';
            comment += '- ğŸ“¥ [OpenAPI ë‹¤ìš´ë¡œë“œ](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/openapi.json)\n';

            // PRì— ì½”ë©˜íŠ¸ ì‘ì„±
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Breakingì´ ìˆìœ¼ë©´ ë¦¬ë·° ìš”ì²­
        if: steps.breaking.outputs.has_breaking == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            // Breakingì´ ìˆìœ¼ë©´ íŠ¹ì • íŒ€ì›ì—ê²Œ ë¦¬ë·° ìš”ì²­
            // í•„ìš”ì‹œ íŒ€ì› usernameìœ¼ë¡œ ë³€ê²½
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              reviewers: [], // ì˜ˆ: ['frontend-lead', 'tech-lead']
            });

      - name: ì²´í¬ ìƒíƒœ ì„¤ì •
        if: steps.breaking.outputs.has_breaking == 'true'
        run: |
          echo "âš ï¸ Breaking changesê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "í”„ë¡ íŠ¸ì—”ë“œ íŒ€ì˜ ìŠ¹ì¸ í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”."
          # exit 1ì„ ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ PRì„ ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ
          # íŒ€ ì •ì±…ì— ë”°ë¼ ì£¼ì„ í•´ì œ ê°€ëŠ¥
          # exit 1
