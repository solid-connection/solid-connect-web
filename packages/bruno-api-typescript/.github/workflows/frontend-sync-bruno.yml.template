# í”„ë¡ íŠ¸ì—”ë“œ ì €ì¥ì†Œìš© Workflow
# ì´ íŒŒì¼ì„ í”„ë¡ íŠ¸ì—”ë“œ ì €ì¥ì†Œì˜ .github/workflows/ í´ë”ì— ë³µì‚¬í•˜ì„¸ìš”

name: Sync Bruno API Changes

on:
  repository_dispatch:
    types: [bruno_updated]
  workflow_dispatch:
    inputs:
      bruno_repo:
        description: 'Bruno Repository (org/repo)'
        required: false
        default: 'YOUR-ORG/BRUNO-REPO'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Frontend Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Get Bruno Repository Info
        id: bruno_info
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "repo=${{ github.event.client_payload.bruno_repo }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.commit_sha }}" >> $GITHUB_OUTPUT
            echo "message=${{ github.event.client_payload.commit_message }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ github.event.inputs.bruno_repo }}" >> $GITHUB_OUTPUT
            echo "sha=main" >> $GITHUB_OUTPUT
            echo "message=Manual sync" >> $GITHUB_OUTPUT
          fi

      - name: Clone Bruno Repository
        run: |
          echo "ğŸ“¥ Cloning Bruno repository: ${{ steps.bruno_info.outputs.repo }}"
          git clone https://github.com/${{ steps.bruno_info.outputs.repo }}.git /tmp/bruno
          cd /tmp/bruno
          git checkout ${{ steps.bruno_info.outputs.sha }} || git checkout main
          echo "âœ… Bruno repository cloned successfully"

      - name: Install Dependencies
        run: npm install

      - name: Generate OpenAPI and Detect Changes
        run: |
          echo "ğŸ”„ Generating OpenAPI spec..."

          # ì´ì „ ë²„ì „ ë°±ì—… (ë³€ê²½ì‚¬í•­ ê°ì§€ìš©)
          if [ -f public/openapi.json ]; then
            cp public/openapi.json public/openapi.json.old
          fi

          # OpenAPI ìƒì„±
          npx bruno-sync generate \
            -i /tmp/bruno/bruno \
            -o ./public/openapi.json \
            --title "ìš°ë¦¬íŒ€ API" \
            --version "1.0.0"

          # ë³€ê²½ì‚¬í•­ ê°ì§€
          if [ -f public/openapi.json.old ]; then
            echo "ğŸ” Detecting changes..."
            cp public/openapi.json.old public/openapi.json.old.bak
            npx bruno-sync generate \
              -i /tmp/bruno/bruno \
              -o ./public/openapi.json \
              --diff \
              --changelog ./public/CHANGELOG.md \
              --changelog-format markdown

            # HTML Changelogë„ ìƒì„±
            npx bruno-sync generate \
              -i /tmp/bruno/bruno \
              -o ./public/openapi.json \
              --diff \
              --changelog ./public/changelog.html \
              --changelog-format html

            echo "âœ… Changes detected and documented"
          else
            echo "â„¹ï¸  No previous version found, skipping diff"
          fi

      - name: Check for Changes
        id: changes
        run: |
          git add public/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected!"

            # Breaking changes í™•ì¸
            if [ -f public/CHANGELOG.md ]; then
              if grep -q "Breaking Changes" public/CHANGELOG.md; then
                echo "has_breaking=true" >> $GITHUB_OUTPUT
                echo "âš ï¸  Breaking changes detected!"
              else
                echo "has_breaking=false" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: sync API spec from Bruno

            Bruno Repository: ${{ steps.bruno_info.outputs.repo }}
            Commit: ${{ steps.bruno_info.outputs.sha }}
            Message: ${{ steps.bruno_info.outputs.message }}
          branch: api-sync-${{ steps.bruno_info.outputs.sha }}
          delete-branch: true
          title: "ğŸ”„ API ë³€ê²½ì‚¬í•­ ë™ê¸°í™” (${{ steps.bruno_info.outputs.sha }})"
          body: |
            ## ğŸ”„ Bruno API ë³€ê²½ì‚¬í•­ ìë™ ë™ê¸°í™”

            **Bruno Repository**: [`${{ steps.bruno_info.outputs.repo }}`](https://github.com/${{ steps.bruno_info.outputs.repo }})
            **Commit**: `${{ steps.bruno_info.outputs.sha }}`
            **Author**: ${{ github.event.client_payload.author || 'N/A' }}
            **Message**:
            ```
            ${{ steps.bruno_info.outputs.message }}
            ```

            ---

            ### ğŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½

            ${{ steps.changes.outputs.has_breaking == 'true' && '### âš ï¸ **Breaking Changes ë°œê²¬!**\n\n> ê¸°ì¡´ ì½”ë“œë¥¼ ê¹¨ëœ¨ë¦´ ìˆ˜ ìˆëŠ” ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì£¼ì˜ ê¹Šê²Œ ë¦¬ë·°í•´ì£¼ì„¸ìš”.\n\n' || '' }}

            ìƒì„¸ ë³€ê²½ì‚¬í•­ì€ ì•„ë˜ íŒŒì¼ë“¤ì„ í™•ì¸í•˜ì„¸ìš”:
            - ğŸ“„ [OpenAPI Spec](../blob/${{ github.ref_name }}/public/openapi.json)
            - ğŸ“ [Changelog (Markdown)](../blob/${{ github.ref_name }}/public/CHANGELOG.md)
            - ğŸ¨ [Changelog (HTML)](../blob/${{ github.ref_name }}/public/changelog.html)

            ---

            ### âœ… ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

            - [ ] Breaking changes í™•ì¸ ë° ëŒ€ì‘ ë°©ì•ˆ ìˆ˜ë¦½
            - [ ] ì˜í–¥ë°›ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ íŒŒì•…
            - [ ] Swagger UIì—ì„œ ìƒˆ API ìŠ¤í™ í™•ì¸
            - [ ] íƒ€ì… ì—ëŸ¬ ì—†ëŠ”ì§€ í™•ì¸ (`npm run build`)
            - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸ (`npm run test`)

            ---

            ### ğŸ”— ìœ ìš©í•œ ë§í¬

            - ğŸŒ [Swagger UIë¡œ ë³´ê¸°](https://your-org.github.io/your-repo/api-viewer.html)
            - ğŸ“Š [ë³€ê²½ì‚¬í•­ ëŒ€ì‹œë³´ë“œ](https://your-org.github.io/your-repo/changelog.html)
            - ğŸ“š [Bruno ì €ì¥ì†Œ](https://github.com/${{ steps.bruno_info.outputs.repo }})

            ---

            <sub>ğŸ¤– ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</sub>
          labels: |
            api-sync
            autogenerated
            ${{ steps.changes.outputs.has_breaking == 'true' && 'breaking-change' || '' }}

      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ğŸ‰ API ë™ê¸°í™” ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **Bruno Commit**: \`${{ steps.bruno_info.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Message**: ${{ steps.bruno_info.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changes.outputs.has_breaking }}" = "true" ]; then
            echo "### âš ï¸ Breaking Changes" >> $GITHUB_STEP_SUMMARY
            echo "Breaking changesê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. PRì„ ì£¼ì˜ê¹Šê²Œ ë¦¬ë·°í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ğŸ”— ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          echo "1. [Pull Requests](../../pulls)ì—ì„œ ìë™ ìƒì„±ëœ PR í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "2. Changelog í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "3. ì½”ë“œ ë¦¬ë·° ë° ë¨¸ì§€" >> $GITHUB_STEP_SUMMARY

      - name: No Changes
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "Bruno repositoryê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆì§€ë§Œ OpenAPI ìŠ¤í™ì—ëŠ” ë³€ê²½ì´ ì—†ìŠµë‹ˆë‹¤."

# ì„¤ì • ë°©ë²•:
# 1. YOUR-ORG/BRUNO-REPOë¥¼ ì‹¤ì œ Bruno ì €ì¥ì†Œ ê²½ë¡œë¡œ ë³€ê²½
# 2. public/ ê²½ë¡œë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì • (ì˜ˆ: src/api/, docs/ ë“±)
# 3. Swagger UI ë§í¬ë¥¼ ì‹¤ì œ ë°°í¬ URLë¡œ ë³€ê²½
