name: Update API Hooks (Frontend Repo)

# ğŸ¯ ì´ íŒŒì¼ì€ í”„ë¡ íŠ¸ì—”ë“œ ë¦¬í¬ì— ì¶”ê°€í•˜ì„¸ìš”
# Repository Dispatch ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ API í›…ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤

on:
  repository_dispatch:
    types: [bruno_updated]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  update-hooks:
    runs-on: ubuntu-latest

    steps:
      # í”„ë¡ íŠ¸ì—”ë“œ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Frontend Repo
        uses: actions/checkout@v4

      # Bruno ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Bruno Repo
        uses: actions/checkout@v4
        with:
          # âš ï¸ ë³€ê²½ í•„ìš”: Bruno ë¦¬í¬ ê²½ë¡œ
          repository: YOUR_USERNAME/YOUR_BRUNO_REPO
          path: bruno-repo

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # bruno-api-typescript ì„¤ì¹˜
      - name: Install Dependencies
        run: |
          npm install -D github:manNomi/bruno-api-typescript

      # React Query í›… ìƒì„±
      - name: Generate React Query Hooks
        run: |
          npx bruno-api generate-hooks \
            -i bruno-repo/bruno \
            -o ./src/apis \
            --axios-path "@/utils/axiosInstance"

      # ë³€ê²½ì‚¬í•­ í™•ì¸
      - name: Check for changes
        id: git-check
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # ë¸Œëœì¹˜ ìƒì„± ë° ì»¤ë°‹
      - name: Commit and Push
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="auto/api-hooks-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME

          git add src/apis
          git commit -m "chore: update API hooks

          ğŸ¤– Triggered by Bruno repository update
          Source SHA: ${{ github.event.client_payload.sha }}"

          git push origin $BRANCH_NAME

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: commit

      # PR ìƒì„±
      - name: Create Pull Request
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          gh pr create \
            --title "ğŸ”„ Update API Hooks" \
            --body "Auto-generated from Bruno repository update" \
            --base main \
            --head ${{ steps.commit.outputs.branch_name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
