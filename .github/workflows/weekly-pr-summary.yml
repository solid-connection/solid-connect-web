name: Weekly PR Summary

on:
  pull_request_target:
    types: [opened]
  schedule:
    # ë§¤ì£¼ ê¸ˆìš”ì¼ 13:00 UTC (22:00 KST)
    - cron: '0 13 * * 5'
  workflow_dispatch:

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Collect merged PRs from last 7 days
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 7ì¼ ì „ ë‚ ì§œ ê³„ì‚°
          SINCE_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)

          echo "Fetching PRs merged since: $SINCE_DATE"

          # ìµœê·¼ 7ì¼ê°„ ë¨¸ì§€ëœ PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          gh pr list \
            --repo "$REPO" \
            --state merged \
            --limit 100 \
            --json number,title,author,labels,mergedAt,url \
            --jq --arg since "$SINCE_DATE" '
              map(select(.mergedAt >= $since)) |
              sort_by(.mergedAt) |
              reverse
            ' > prs.json

          # PR ê°œìˆ˜ í™•ì¸
          PR_COUNT=$(jq 'length' prs.json)
          echo "Found $PR_COUNT merged PRs"

          # ê²°ê³¼ ì €ìž¥
          echo "PR_COUNT=$PR_COUNT" >> $GITHUB_ENV

      - name: Generate summary message
        run: |
          # ë‚ ì§œ ê³„ì‚°
          END_DATE=$(date -u +%Y-%m-%d)
          START_DATE=$(date -u -d '7 days ago' +%Y-%m-%d)

          # PR ëª©ë¡ ìƒì„±
          PR_LIST=$(jq -r '
            map(
              "- " + .title +
              " (#" + (.number | tostring) + ") â€” " + .author.login +
              (
                if (.labels | length) > 0 then
                  "\n  ðŸ· " + ([.labels[].name] | join(", "))
                else
                  ""
                end
              ) +
              "\n  ðŸ”— " + .url
            ) | join("\n\n")
          ' prs.json)

          # ë©”ì‹œì§€ê°€ ë¹„ì–´ìžˆì„ ê²½ìš° ì²˜ë¦¬
          if [ "$PR_COUNT" -eq 0 ]; then
            PR_LIST="ì´ë²ˆ ì£¼ì— ë¨¸ì§€ëœ PRì´ ì—†ìŠµë‹ˆë‹¤."
          fi

          # ë©”ì‹œì§€ ìƒì„±
          cat > message.txt <<EOF
**ðŸ“Š ì´ë²ˆ ì£¼ ìž‘ì—… ìš”ì•½**

**ê¸°ê°„:** $START_DATE ~ $END_DATE
**ì´ ë¨¸ì§€ëœ PR:** $PR_COUNTê°œ

$PR_LIST
EOF

          echo "Generated summary message"

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # ë©”ì‹œì§€ ì½ê¸°
          MESSAGE=$(cat message.txt)

          # Discordë¡œ ì „ì†¡
          jq -n \
            --arg username "ì£¼ê°„ PR ìš”ì•½ë´‡" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg content "$MESSAGE" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              content: $content
            }' | curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d @-

          echo "âœ… Weekly summary sent to Discord"
